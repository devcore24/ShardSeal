groups:
- name: shardseal.alerts
  rules:
  - record: job:shardseal:http_requests:rate5m
    expr: sum by (method, code) (rate(shardseal_http_requests_total[5m]))
  - record: job:shardseal:http_error_ratio5m
    expr: sum(rate(shardseal_http_requests_total{code=~"5.."}[5m])) / sum(rate(shardseal_http_requests_total[5m]))
  - alert: ShardSealHighHTTPErrorRate
    expr: job:shardseal:http_error_ratio5m > 0.02
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "ShardSeal high HTTP 5xx error rate"
      description: "5xx error ratio over 5m is {{ $value | printf \"%.2f\" }} (> 2%)."
  - record: job:shardseal:http_request_duration_seconds:p99
    expr: histogram_quantile(0.99, sum by (le, method) (rate(shardseal_http_request_duration_seconds_bucket[5m])))
  - alert: ShardSealHighLatencyP99
    expr: job:shardseal:http_request_duration_seconds:p99 > 1
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "ShardSeal high p99 latency"
      description: "HTTP p99 latency over 5m is {{ $value }}s (> 1s)."
  - alert: ShardSealIntegrityFailures
    expr: rate(shardseal_storage_integrity_failures_total[5m]) > 0
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Integrity failures detected in sealed I/O"
      description: "Observed non-zero rate of integrity failures over 5m. Investigate disks and recent deployments."
  - record: job:shardseal:sealed_ops_integrity_fail_ratio5m
    expr: sum(rate(shardseal_storage_sealed_ops_total{integrity_fail="true"}[5m])) / sum(rate(shardseal_storage_sealed_ops_total[5m]))
  - alert: ShardSealSealedIntegrityFailRatioHigh
    expr: job:shardseal:sealed_ops_integrity_fail_ratio5m > 0.01
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "High fraction of sealed ops with integrity failures"
      description: "More than 1% of sealed ops show integrity_fail=true over 10m (value: {{ $value }})."
  - alert: ShardSealNoMetrics
    expr: absent(shardseal_http_requests_total)
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "No ShardSeal metrics scraped"
      description: "Prometheus has not scraped shardseal metrics for 5 minutes on this target."