groups:
- name: shardseal.alerts
  rules:
  - record: job:shardseal:http_requests:rate5m
    expr: sum by (method, code) (rate(shardseal_http_requests_total[5m]))
  - record: job:shardseal:http_error_ratio5m
    expr: sum(rate(shardseal_http_requests_total{code=~"5.."}[5m])) / sum(rate(shardseal_http_requests_total[5m]))
  - alert: ShardSealHighHTTPErrorRate
    expr: job:shardseal:http_error_ratio5m > 0.02
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "ShardSeal high HTTP 5xx error rate"
      description: "5xx error ratio over 5m is {{ $value | printf \"%.2f\" }} (> 2%)."
  - record: job:shardseal:http_request_duration_seconds:p99
    expr: histogram_quantile(0.99, sum by (le, method) (rate(shardseal_http_request_duration_seconds_bucket[5m])))
  - alert: ShardSealHighLatencyP99
    expr: job:shardseal:http_request_duration_seconds:p99 > 1
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "ShardSeal high p99 latency"
      description: "HTTP p99 latency over 5m is {{ $value }}s (> 1s)."
  - alert: ShardSealIntegrityFailures
    expr: rate(shardseal_storage_integrity_failures_total[5m]) > 0
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Integrity failures detected in sealed I/O"
      description: "Observed non-zero rate of integrity failures over 5m. Investigate disks and recent deployments."
  - record: job:shardseal:sealed_ops_integrity_fail_ratio5m
    expr: sum(rate(shardseal_storage_sealed_ops_total{integrity_fail="true"}[5m])) / sum(rate(shardseal_storage_sealed_ops_total[5m]))
  - alert: ShardSealSealedIntegrityFailRatioHigh
    expr: job:shardseal:sealed_ops_integrity_fail_ratio5m > 0.01
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "High fraction of sealed ops with integrity failures"
      description: "More than 1% of sealed ops show integrity_fail=true over 10m (value: {{ $value }})."
  - alert: ShardSealNoMetrics
    expr: absent(shardseal_http_requests_total)
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "No ShardSeal metrics scraped"
      description: "Prometheus has not scraped shardseal metrics for 5 minutes on this target."

  # Scrubber metrics: rates and alerts
  - record: job:shardseal:scrubber_errors_rate5m
    expr: rate(shardseal_scrubber_errors_total[5m])
  - record: job:shardseal:scrubber_scanned_rate5m
    expr: rate(shardseal_scrubber_scanned_total[5m])

  - alert: ShardSealScrubberHighErrorRate
    expr: job:shardseal:scrubber_errors_rate5m > 0
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "Scrubber is reporting errors"
      description: "Scrubber errors rate over 5m is {{ $value }} (> 0). Inspect sealed object integrity and storage health."

  - alert: ShardSealScrubberLastRunStale
    expr: (time() - max_over_time(shardseal_scrubber_last_run_timestamp_seconds[30m])) > 3600
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "Scrubber last run is stale"
      description: "The last completed scrub pass was over 60 minutes ago. Verify scrubber is running and has access to data."

  - alert: ShardSealScrubberNotRunning
    expr: absent(shardseal_scrubber_uptime_seconds) or min_over_time(shardseal_scrubber_uptime_seconds[10m]) == 0
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "Scrubber not running"
      description: "Scrubber uptime is zero or metric absent for at least 10 minutes. Check configuration and logs."

  # Repair queue metrics: recording rules and alerts
  - record: job:shardseal:repair_queue_depth
    expr: sum(shardseal_repair_queue_depth)

  - alert: ShardSealRepairQueueNonZero
    expr: job:shardseal:repair_queue_depth > 0
    for: 15m
    labels:
      severity: warning
    annotations:
      summary: "Repair queue non-zero"
      description: "Repair queue depth has been greater than zero for 15 minutes (depth={{ $value }}). Investigate scrub failures or read-time integrity issues."

  - alert: ShardSealRepairQueueHigh
    expr: job:shardseal:repair_queue_depth > 100
    for: 10m
    labels:
      severity: critical
    annotations:
      summary: "High repair queue depth"
      description: "Repair queue depth has exceeded 100 items for 10 minutes (depth={{ $value }}). Capacity or integrity incident likely; prioritize remediation."

  - alert: ShardSealRepairMetricsMissing
    expr: absent(shardseal_repair_queue_depth)
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "Repair metrics missing"
      description: "Prometheus has not observed repair queue metrics for 10 minutes. Verify admin is enabled and repair metrics polling is active."